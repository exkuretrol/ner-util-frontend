{% extends "base.twig" %} {% block title %}管理頁面{% endblock title %} {% block
head %}
{{ parent() }}
<style type="text/tailwindcss">
    @layer components {
        .confirm-delete {
            @apply bg-red-500;
        }

        .modifying {
            @apply bg-emerald-300;
        }
    }
</style>
<script src="https://code.jquery.com/ui/1.13.2/jquery-ui.js"></script>
<script>
    document.addEventListener("DOMContentLoaded", () => {
        $("#tabs").tabs();

        /**
         * 變更 ner 標籤
         */
        function load_table() {
            $.ajax({
                url: "/api/ner/category",
            }).then((res) => {
                res.map((option, i) => {
                    const row = `
                    <tr id="${"cate" + option.ID}">
                        <td>
                            <input class="name" type="text" value="${
                                option.Name
                            }" disabled>
                        </td>
                        <td>
                            <input class="tag" type="text" value="${
                                option.Tag
                            }" disabled>
                        </td>
                        <td class="modify">✏️</td>
                        <td class="delete">🗑️</td>
                    </tr>
                    `;
                    $("#category-table > tbody").append(row);
                    $(`#cate${option.ID} .delete`).on("click", (e) => {
                        if (
                            $(`#cate${option.ID} .delete`).hasClass(
                                "confirm-delete"
                            )
                        ) {
                            $(`#cate${option.ID}`).remove();
                            $.ajax({
                                url: `/api/ner/category/${option.ID}`,
                                type: "delete",
                                contentType: "application/json; charset=utf-8",
                            });
                        } else {
                            $(`#cate${option.ID} .delete`).addClass(
                                "confirm-delete"
                            );
                        }
                    });

                    $(`#cate${option.ID} .modify`).on("click", (e) => {
                        if ($(`#cate${option.ID} .modify`).text() == "✏️") {
                            $(`#cate${option.ID} input`).removeAttr(
                                "disabled",
                                false
                            );
                            $(`#cate${option.ID} .modify`).addClass(
                                "modifying"
                            );

                            $(`#cate${option.ID} .modify`).text("👌");
                            // console.log("can modify");
                        } else {
                            $(`#cate${option.ID} input`).attr("disabled", true);
                            $(`#cate${option.ID} .modify`).removeClass(
                                "modifying"
                            );
                            $(`#cate${option.ID} .modify`).text("✏️");

                            const data = {
                                ID: option.ID,
                                Name: $(`#cate${option.ID} input.name`).val(),
                                Tag: $(`#cate${option.ID} input.tag`).val(),
                            };

                            $.ajax({
                                url: `/api/ner/category`,
                                type: "put",
                                data: JSON.stringify(data),
                                contentType: "application/json; charset=utf-8",
                            });
                            // console.log("cann't modify");
                        }
                    });
                });
            });
        }
        load_table();

        $("#create-tag").on("click", (e) => {
            const name = $("#new-category-name").val();
            const tag = $("#new-category-tag").val();
            if (name !== "" && tag !== "") {
                $.ajax({
                    url: `/api/ner/category`,
                    type: "post",
                    data: JSON.stringify({ Name: name, Tag: tag }),
                    contentType: "application/json; charset=utf-8",
                    success: () => {
                        $("#new-category-name").val("");
                        $("#new-category-tag").val("");
                        $("#category-table > tbody").children().remove();
                        load_table();
                    },
                });
            }
        });

        /**
         * 輸出測資
         */
        let url;
        $("#download-btn").attr("disabled", true);
        $("#download-btn").on("click", (e) => {
            e.preventDefault();
            document.getElementById("download-link").click();
            $("#download-link").remove();
            $("#download-btn").attr("disabled", true);
        });
        $("#output-ner-data-to-json").on("change", (e) => {
            const mode = e.target.value;
            if (mode === "null") return;
            $.ajax({
                type: "get",
                url: `/api/output/${mode}`,
                success: (res) => {
                    let json = new Blob(
                        [
                            JSON.stringify(res)
                                .replace(/\[{"tokens"/g, '{"tokens"')
                                .replace(/\]}]/g, "]}")
                                .replace(/,{"tokens"/g, '\n{"tokens"'),
                        ],
                        { type: "application/json" }
                    );
                    url = URL.createObjectURL(json);
                    let downloadLink = document.createElement("a");
                    downloadLink.id = "download-link";
                    downloadLink.download = $(
                        "#output-ner-data-to-json :selected"
                    ).text();
                    downloadLink.href = url;
                    downloadLink.style.display = "none";
                    if ($("#download-link").length > 0)
                        $("#download-link").attr;
                    document.body.appendChild(downloadLink);
                    $("#download-btn").removeAttr("disabled");
                },
            });
        });

        /**
         * 調整網站選項
         */
        function load_option() {
            $.ajax({
                url: "/api/ner/option",
            }).then((options) => {
                for (let option of options) {
                    const opt = dash_underline_conv(option.option_name);
                    const inputs = $(`#${opt} input`);
                    for (let input of inputs) {
                        if (option.option_value === input.value) {
                            console.log($(input).prop("checked", true));
                        }
                    }
                }
            });
            $("input[name='ner-data-type']").on("change", (e) => {
                const el = e.target;
                $.ajax({
                    url: `/api/ner/option`,
                    type: "put",
                    data: JSON.stringify({
                        name: dash_underline_conv($(el).attr("name")),
                        value: $(el).val(),
                    }),
                    contentType: "application/json; charset=utf-8",
                }).then((res) => {
                    $("#ner-data-type .respond-message").text(res.message);
                });
            });
        }
        load_option();

        function dash_underline_conv(string) {
            return string.includes("-")
                ? string.replaceAll("-", "_")
                : string.replaceAll("_", "-");
        }
    });
</script>
{% endblock head %} {% block main %}
<div id="tabs" class="flex flex-row">
    <!-- sidebar -->
    <div class="mr-4 w-60 border-r border-black">
        <ul>
            <li><a href="#tabs-1">輸出測資</a></li>
            <li><a href="#tabs-2">變更 NER 標籤</a></li>
            <li><a href="#tabs-3">調整網站選項</a></li>
        </ul>
    </div>

    <div class="w-auto">
        <div id="tabs-1">
            <label for="output-ner-data-to-json">輸出測資：</label>
            <select name="output-ner-data-to-json" id="output-ner-data-to-json">
                <option value="null" selected>請選擇</option>
                <option value="0">全部測資</option>
                <option value="1">只有輸入測資</option>
                <option value="2">只有語音測資</option>
            </select>
            <div>
                <button id="download-btn">下載</button>
            </div>
        </div>
        <div id="tabs-2">
            <div id="modify-exist-category">
                <table id="category-table">
                    <thead>
                        <tr>
                            <td>名稱</td>
                            <td>標籤</td>
                            <td>編輯</td>
                            <td>移除</td>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            <div id="add-new-tag">
                <div class="flex flex-row">
                    <input
                        id="new-category-name"
                        type="text"
                        placeholder="標籤名稱"
                    />
                    <input
                        id="new-category-tag"
                        type="text"
                        placeholder="英文標籤"
                    />
                </div>
                <button id="create-tag">新增標籤</button>
            </div>
        </div>
        <div id="tabs-3">
            <div id="ner-data-type">
                <fieldset id="ner">
                    <legend>ner 資料類型</legend>
                    <input
                        type="radio"
                        name="ner-data-type"
                        id="data-type-1"
                        value="paragraph"
                    />
                    <label for="data-type-1">短句</label>
                    <input
                        type="radio"
                        name="ner-data-type"
                        id="data-type-2"
                        value="article"
                    />
                    <label for="data-type-2">文章</label>
                    <div class="respond-message"></div>
                </fieldset>
            </div>
        </div>
    </div>
</div>
{% endblock main %}
